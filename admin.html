<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Market Admin - Professional</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --main: #01875f; --danger: #d93025; --bg: #f8f9fa; --blue: #1a73e8; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #3c4043; }
        .container { max-width: 800px; margin: auto; }
        .admin-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h2 { margin-top: 0; color: var(--main); font-size: 22px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 80px; resize: vertical; }
        .btn-save { width: 100%; padding: 14px; background: var(--main); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; min-height: 20px; }
        .preview-img { width: 65px; height: 65px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; background: #eee; }
        .app-list { display: grid; gap: 15px; }
        .app-card { background: white; padding: 15px; border-radius: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .app-card img { width: 60px; height: 60px; border-radius: 12px; margin-right: 15px; object-fit: cover; }
        .app-info { flex-grow: 1; }
        .app-info h3 { margin: 0; font-size: 16px; }
        .actions { display: flex; gap: 8px; }
        .btn-edit, .btn-delete { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 18px; transition: 0.3s; }
        .btn-edit { background: #e8f0fe; color: var(--blue); }
        .btn-delete { background: #fce8e6; color: var(--danger); }
        .btn-edit:hover { background: var(--blue); color: white; }
        .btn-delete:hover { background: var(--danger); color: white; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); position: relative; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-box">
        <h2>Yangi Ilova Qo'shish</h2>
        <input type="text" id="appName" placeholder="Ilova nomi">
        <input type="text" id="appLink" placeholder="Yuklash linki (GitHub direct link)">
        <textarea id="appDesc" placeholder="Ilova haqida tavsif..."></textarea>
        
        <label>Asosiy Ikonka:</label>
        <input type="file" id="appFile" accept="image/*" onchange="handleImage(event, 'main')">
        <div class="preview-container"><img id="previewMain" class="preview-img" style="display:none;"></div>
        
        <label>Skrinshotlar (Bir nechta tanlang):</label>
        <input type="file" id="appScreens" accept="image/*" multiple onchange="handleImage(event, 'screens')">
        <div id="previewScreens" class="preview-container"></div>
        
        <button class="btn-save" onclick="saveApp()">Bazaga qo'shish</button>
    </div>

    <h2>Barcha Ilovalar</h2>
    <div class="app-list" id="appList"></div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h2 style="color: var(--blue);">Ilovani Tahrirlash</h2>
        <input type="text" id="editName" placeholder="Ilova nomi">
        <input type="text" id="editLink" placeholder="Yuklash linki">
        <textarea id="editDesc" placeholder="Tavsif"></textarea>
        
        <label>Ikonkani yangilash:</label>
        <input type="file" id="editFile" accept="image/*" onchange="handleImage(event, 'editMain')">
        <div class="preview-container"><img id="editPreviewMain" class="preview-img"></div>
        
        <label>Skrinshotlarni yangilash (Bir nechta tanlang):</label>
        <input type="file" id="editScreens" accept="image/*" multiple onchange="handleImage(event, 'editScreens')">
        <div id="editPreviewScreens" class="preview-container"></div>
        
        <div style="display:flex; gap: 10px;">
            <button class="btn-save" style="background: var(--blue);" onclick="updateApp()">Saqlash</button>
            <button class="btn-save" style="background: #999;" onclick="closeModal()">Bekor qilish</button>
        </div>
    </div>
</div>

<script>
    // Firebase Sozlamalari
    const firebaseConfig = {
        apiKey: "AIzaSyA7VLHdjPqf_tobSiBczGbN8H7YlFwq9Wg",
        authDomain: "magnetic-alloy-467611-u7.firebaseapp.com",
        databaseURL: "https://magnetic-alloy-467611-u7-default-rtdb.firebaseio.com",
        projectId: "magnetic-alloy-467611-u7",
        storageBucket: "magnetic-alloy-467611-u7.firebasestorage.app",
        messagingSenderId: "589500919880",
        appId: "1:589500919880:web:7b82d037c5e7396d51687d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Vaqtinchalik xotira
    let currentData = {
        mainIcon: "",
        screens: [],
        editMainIcon: "",
        editScreens: []
    };
    let editingId = null;

    // Rasmlarni Base64 ga o'tkazish funksiyasi (Async ishlatildi)
    async function convertToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // Rasm tanlanganda ishlaydigan asosiy funksiya
    async function handleImage(event, type) {
        const files = event.target.files;
        if (!files.length) return;

        if (type === 'main' || type === 'editMain') {
            const base64 = await convertToBase64(files[0]);
            if (type === 'main') {
                currentData.mainIcon = base64;
                document.getElementById('previewMain').src = base64;
                document.getElementById('previewMain').style.display = 'block';
            } else {
                currentData.editMainIcon = base64;
                document.getElementById('editPreviewMain').src = base64;
            }
        } else {
            // Bir nechta skrinshotlar uchun
            const containerId = type === 'screens' ? 'previewScreens' : 'editPreviewScreens';
            const container = document.getElementById(containerId);
            container.innerHTML = ""; // Oldingilarini tozalash
            
            const tempArray = [];
            for (let file of files) {
                const base64 = await convertToBase64(file);
                tempArray.push(base64);
                container.innerHTML += `<img src="${base64}" class="preview-img">`;
            }
            
            if (type === 'screens') {
                currentData.screens = tempArray;
            } else {
                currentData.editScreens = tempArray;
            }
        }
    }

    // Yangi ilova qo'shish
    function saveApp() {
        const name = document.getElementById('appName').value;
        const link = document.getElementById('appLink').value;
        const desc = document.getElementById('appDesc').value;

        if (!name || !link || !currentData.mainIcon) {
            alert("Iltimos, nomi, linki va ikonkani kiriting!");
            return;
        }

        db.ref('apps').push({
            name, link, desc,
            image: currentData.mainIcon,
            screenshots: currentData.screens
        }).then(() => {
            alert("Muvaffaqiyatli qo'shildi!");
            location.reload();
        });
    }

    // Ro'yxatni chiqarish
    db.ref('apps').on('value', snap => {
        const listDiv = document.getElementById('appList');
        listDiv.innerHTML = "";
        snap.forEach(child => {
            const app = child.val();
            listDiv.innerHTML += `
                <div class="app-card">
                    <img src="${app.image}">
                    <div class="app-info"><h3>${app.name}</h3></div>
                    <div class="actions">
                        <button class="btn-edit" onclick="openEditModal('${child.key}')">âœŽ</button>
                        <button class="btn-delete" onclick="deleteApp('${child.key}')">ðŸ—‘</button>
                    </div>
                </div>`;
        });
    });

    // Tahrirlash modalini ochish
    function openEditModal(id) {
        editingId = id;
        db.ref('apps/' + id).once('value', snap => {
            const app = snap.val();
            document.getElementById('editName').value = app.name;
            document.getElementById('editLink').value = app.link;
            document.getElementById('editDesc').value = app.desc || "";
            
            document.getElementById('editPreviewMain').src = app.image;
            currentData.editMainIcon = app.image;
            
            const screenDiv = document.getElementById('editPreviewScreens');
            screenDiv.innerHTML = "";
            currentData.editScreens = app.screenshots || [];
            currentData.editScreens.forEach(src => {
                screenDiv.innerHTML += `<img src="${src}" class="preview-img">`;
            });

            document.getElementById('editModal').style.display = 'flex';
        });
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
        editingId = null;
    }

    // Yangilash (Update)
    function updateApp() {
        if (!editingId) return;

        const updatedData = {
            name: document.getElementById('editName').value,
            link: document.getElementById('editLink').value,
            desc: document.getElementById('editDesc').value,
            image: currentData.editMainIcon,
            screenshots: currentData.editScreens
        };

        db.ref('apps/' + editingId).update(updatedData)
        .then(() => {
            alert("Ma'lumotlar yangilandi!");
            closeModal();
        })
        .catch(error => alert("Xatolik: " + error.message));
    }

    function deleteApp(id) {
        if (confirm("O'chirilsinmi?")) {
            db.ref('apps/' + id).remove();
        }
    }
</script>
</body>
</html>